<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - AKURA SafeStride</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: none;
      }
      .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="login-container">
      <div class="w-full max-w-md px-6">
        <!-- Logo & Title -->
        <div class="text-center mb-8">
          <div
            class="gradient-bg text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"
          >
            <i class="fas fa-running text-3xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            AKURA SafeStride
          </h1>
          <p class="text-gray-600">AI-Powered Injury Prevention Platform</p>
        </div>

        <!-- Login Card -->
        <div class="bg-white rounded-xl shadow-xl p-8">
          <!-- Alert Messages -->
          <div id="alertSuccess" class="alert alert-success">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage"></span>
          </div>

          <div id="alertError" class="alert alert-error">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage"></span>
          </div>

          <h2 class="text-2xl font-bold text-gray-800 mb-6">Sign In</h2>

          <!-- Login Form -->
          <form id="loginForm">
            <!-- Email -->
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-semibold mb-2"
                for="email"
              >
                <i class="fas fa-envelope mr-2 text-gray-500"></i>
                Email Address
              </label>
              <input
                type="email"
                id="email"
                name="email"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent transition"
                placeholder="your@email.com"
                required
                autocomplete="email"
              />
            </div>

            <!-- Password -->
            <div class="mb-6">
              <label
                class="block text-gray-700 text-sm font-semibold mb-2"
                for="password"
              >
                <i class="fas fa-lock mr-2 text-gray-500"></i>
                Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent transition pr-12"
                  placeholder="Enter your password"
                  required
                  autocomplete="current-password"
                />
                <button
                  type="button"
                  id="togglePassword"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye" id="eyeIcon"></i>
                </button>
              </div>
            </div>

            <!-- Remember Me & Forgot Password -->
            <div class="flex items-center justify-between mb-6">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="rememberMe"
                  class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                />
                <span class="ml-2 text-sm text-gray-600">Remember me</span>
              </label>
              <a
                href="#"
                class="text-sm text-purple-600 hover:text-purple-800 font-semibold"
                >Forgot password?</a
              >
            </div>

            <!-- Login Button -->
            <button
              type="submit"
              id="loginButton"
              class="w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition duration-200 shadow-lg"
            >
              <i class="fas fa-sign-in-alt mr-2"></i>
              Sign In
            </button>
          </form>

          <!-- Loading Spinner -->
          <div id="loadingSpinner" class="hidden text-center mt-6">
            <i class="fas fa-spinner fa-spin text-3xl text-purple-600"></i>
            <p class="text-gray-600 mt-2">Authenticating...</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-gray-600 text-sm">
          <p>¬© 2026 AKURA SafeStride. All rights reserved.</p>
          <p class="mt-2">
            <a
              href="https://www.akura.in"
              class="text-purple-600 hover:text-purple-800"
              >www.akura.in</a
            >
          </p>
        </div>
      </div>
    </div>

    <script>
      // Supabase Configuration
      const SUPABASE_URL = "https://bdisppaxbvygsspcuymb.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaXNwcGF4YnZ5Z3NzcGN1eW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDY4NDQsImV4cCI6MjA4NjgyMjg0NH0.bjgoVhVboDQTmIPe_A5_4yiWvTBvckVtw88lQ7GWFrc";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
      );

      // DOM Elements
      const loginForm = document.getElementById("loginForm");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const loginButton = document.getElementById("loginButton");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const togglePasswordBtn = document.getElementById("togglePassword");
      const eyeIcon = document.getElementById("eyeIcon");
      const alertSuccess = document.getElementById("alertSuccess");
      const alertError = document.getElementById("alertError");
      const successMessage = document.getElementById("successMessage");
      const errorMessage = document.getElementById("errorMessage");
      const rememberMeCheckbox = document.getElementById("rememberMe");

      // Check if already logged in
      const currentUser =
        localStorage.getItem("akura_user") ||
        sessionStorage.getItem("akura_user");
      if (currentUser) {
        const user = JSON.parse(currentUser);
        redirectToDashboard(user.role_name);
      }

      // Toggle password visibility
      togglePasswordBtn.addEventListener("click", () => {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        eyeIcon.className =
          type === "password" ? "fas fa-eye" : "fas fa-eye-slash";
      });

      // Show alert message
      function showAlert(type, message) {
        if (type === "success") {
          alertSuccess.style.display = "block";
          alertError.style.display = "none";
          successMessage.textContent = message;
        } else {
          alertError.style.display = "block";
          alertSuccess.style.display = "none";
          errorMessage.textContent = message;
        }

        // Auto-hide after 5 seconds
        setTimeout(() => {
          alertSuccess.style.display = "none";
          alertError.style.display = "none";
        }, 5000);
      }

      // Redirect to appropriate dashboard
      function redirectToDashboard(role) {
        const dashboardMap = {
          admin: "/admin-dashboard.html",
          coach: "/coach-dashboard.html",
          athlete: "/athlete-dashboard.html",
        };

        const dashboard = dashboardMap[role] || "/athlete-dashboard.html";
        window.location.href = dashboard;
      }

      // Handle form submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const rememberMe = rememberMeCheckbox.checked;

        // Validate inputs
        if (!email || !password) {
          showAlert("error", "Please enter both email and password");
          return;
        }

        // Show loading
        loginButton.disabled = true;
        loginButton.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Signing in...';
        loadingSpinner.classList.remove("hidden");

        try {
          // Call authentication function
          const { data, error } = await supabaseClient.rpc(
            "authenticate_user",
            {
              p_email: email,
              p_password: password,
              p_ip_address: await getClientIP(),
            },
          );

          if (error) {
            throw error;
          }

          // Check if authentication was successful
          if (!data || data.length === 0 || !data[0].success) {
            throw new Error(data[0]?.message || "Invalid email or password");
          }

          const user = data[0];

          // Check if password change is required
          if (user.must_change_password) {
            // Store user info temporarily
            sessionStorage.setItem("temp_user", JSON.stringify(user));
            // Redirect to password change page
            window.location.href = "/change-password.html";
            return;
          }

          // Store user session
          const sessionData = {
            user_id: user.user_id,
            email: user.email,
            full_name: user.full_name,
            role_name: user.role_name,
            coach_id: user.coach_id,
            athlete_uid: user.athlete_uid,
            logged_in_at: new Date().toISOString(),
          };

          if (rememberMe) {
            localStorage.setItem("akura_user", JSON.stringify(sessionData));
          } else {
            sessionStorage.setItem("akura_user", JSON.stringify(sessionData));
          }

          // Show success message
          showAlert("success", `Welcome back, ${user.full_name}!`);

          // Redirect after 1 second
          setTimeout(() => {
            redirectToDashboard(user.role_name);
          }, 1000);
        } catch (err) {
          console.error("Login error:", err);
          showAlert("error", err.message || "An error occurred during login");

          // Reset button
          loginButton.disabled = false;
          loginButton.innerHTML =
            '<i class="fas fa-sign-in-alt mr-2"></i>Sign In';
          loadingSpinner.classList.add("hidden");
        }
      });

      // Get client IP address (approximate)
      async function getClientIP() {
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          const data = await response.json();
          return data.ip;
        } catch (err) {
          return "unknown";
        }
      }

      // Test credentials info (remove in production)
      console.log(
        "%cüîê Test Credentials:",
        "color: #667eea; font-size: 16px; font-weight: bold;",
      );
      console.log(
        "%cAdmin: admin@akura.in / Admin@123",
        "color: #667eea; font-size: 14px;",
      );
      console.log(
        "%cCoach: coach@akura.in / Coach@123",
        "color: #667eea; font-size: 14px;",
      );
    </script>
  </body>
</html>
