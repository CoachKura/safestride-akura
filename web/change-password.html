<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Change Password - AKURA SafeStride</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: none;
      }
      .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .password-strength {
        height: 4px;
        border-radius: 2px;
        margin-top: 8px;
        transition: all 0.3s;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="login-container">
      <div class="w-full max-w-md px-6">
        <!-- Logo & Title -->
        <div class="text-center mb-8">
          <div
            class="gradient-bg text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"
          >
            <i class="fas fa-lock text-3xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">Change Password</h1>
          <p class="text-gray-600">Please create a new secure password</p>
        </div>

        <!-- Change Password Card -->
        <div class="bg-white rounded-xl shadow-xl p-8">
          <!-- Alert Messages -->
          <div id="alertSuccess" class="alert alert-success">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage"></span>
          </div>

          <div id="alertError" class="alert alert-error">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage"></span>
          </div>

          <!-- User Info -->
          <div id="userInfo" class="mb-6 p-4 bg-purple-50 rounded-lg">
            <p class="text-sm text-gray-700">
              <i class="fas fa-user mr-2"></i>
              Logged in as: <strong id="userEmail"></strong>
            </p>
          </div>

          <!-- Change Password Form -->
          <form id="changePasswordForm">
            <!-- Current Password -->
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-semibold mb-2"
                for="currentPassword"
              >
                <i class="fas fa-key mr-2 text-gray-500"></i>
                Current Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="currentPassword"
                  name="currentPassword"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent transition pr-12"
                  placeholder="Enter current password"
                  required
                />
                <button
                  type="button"
                  id="toggleCurrent"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <!-- New Password -->
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-semibold mb-2"
                for="newPassword"
              >
                <i class="fas fa-lock mr-2 text-gray-500"></i>
                New Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent transition pr-12"
                  placeholder="Enter new password"
                  required
                />
                <button
                  type="button"
                  id="toggleNew"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div
                class="password-strength bg-gray-200"
                id="passwordStrength"
              ></div>
              <p class="text-xs text-gray-500 mt-2" id="strengthText">
                Password must be at least 8 characters
              </p>
            </div>

            <!-- Confirm Password -->
            <div class="mb-6">
              <label
                class="block text-gray-700 text-sm font-semibold mb-2"
                for="confirmPassword"
              >
                <i class="fas fa-lock mr-2 text-gray-500"></i>
                Confirm New Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent transition pr-12"
                  placeholder="Confirm new password"
                  required
                />
                <button
                  type="button"
                  id="toggleConfirm"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <!-- Password Requirements -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
              <p class="text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Password Requirements:
              </p>
              <ul class="text-xs text-gray-600 space-y-1">
                <li id="req-length">
                  <i
                    class="fas fa-circle text-gray-400 mr-2"
                    style="font-size: 6px"
                  ></i
                  >At least 8 characters
                </li>
                <li id="req-uppercase">
                  <i
                    class="fas fa-circle text-gray-400 mr-2"
                    style="font-size: 6px"
                  ></i
                  >One uppercase letter
                </li>
                <li id="req-lowercase">
                  <i
                    class="fas fa-circle text-gray-400 mr-2"
                    style="font-size: 6px"
                  ></i
                  >One lowercase letter
                </li>
                <li id="req-number">
                  <i
                    class="fas fa-circle text-gray-400 mr-2"
                    style="font-size: 6px"
                  ></i
                  >One number
                </li>
              </ul>
            </div>

            <!-- Change Password Button -->
            <button
              type="submit"
              id="changePasswordButton"
              class="w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition duration-200 shadow-lg"
            >
              <i class="fas fa-check mr-2"></i>
              Change Password
            </button>
          </form>

          <!-- Loading Spinner -->
          <div id="loadingSpinner" class="hidden text-center mt-6">
            <i class="fas fa-spinner fa-spin text-3xl text-purple-600"></i>
            <p class="text-gray-600 mt-2">Updating password...</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-gray-600 text-sm">
          <p>Â© 2026 AKURA SafeStride. All rights reserved.</p>
        </div>
      </div>
    </div>

    <script>
      // Supabase Configuration
      const SUPABASE_URL = "https://bdisppaxbvygsspcuymb.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaXNwcGF4YnZ5Z3NzcGN1eW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDY4NDQsImV4cCI6MjA4NjgyMjg0NH0.bjgoVhVboDQTmIPe_A5_4yiWvTBvckVtw88lQ7GWFrc";

      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Get temporary user data
      const tempUser = sessionStorage.getItem("temp_user");
      if (!tempUser) {
        window.location.href = "/login.html";
      }

      const user = JSON.parse(tempUser);
      document.getElementById("userEmail").textContent = user.email;

      // DOM Elements
      const form = document.getElementById("changePasswordForm");
      const currentPasswordInput = document.getElementById("currentPassword");
      const newPasswordInput = document.getElementById("newPassword");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const changePasswordButton = document.getElementById(
        "changePasswordButton",
      );
      const loadingSpinner = document.getElementById("loadingSpinner");
      const passwordStrength = document.getElementById("passwordStrength");
      const strengthText = document.getElementById("strengthText");

      // Toggle password visibility
      document
        .getElementById("toggleCurrent")
        .addEventListener("click", () =>
          togglePassword(
            currentPasswordInput,
            document.querySelector("#toggleCurrent i"),
          ),
        );
      document
        .getElementById("toggleNew")
        .addEventListener("click", () =>
          togglePassword(
            newPasswordInput,
            document.querySelector("#toggleNew i"),
          ),
        );
      document
        .getElementById("toggleConfirm")
        .addEventListener("click", () =>
          togglePassword(
            confirmPasswordInput,
            document.querySelector("#toggleConfirm i"),
          ),
        );

      function togglePassword(input, icon) {
        const type = input.type === "password" ? "text" : "password";
        input.type = type;
        icon.className =
          type === "password" ? "fas fa-eye" : "fas fa-eye-slash";
      }

      // Show alert message
      function showAlert(type, message) {
        const alertSuccess = document.getElementById("alertSuccess");
        const alertError = document.getElementById("alertError");
        const successMessage = document.getElementById("successMessage");
        const errorMessage = document.getElementById("errorMessage");

        if (type === "success") {
          alertSuccess.style.display = "block";
          alertError.style.display = "none";
          successMessage.textContent = message;
        } else {
          alertError.style.display = "block";
          alertSuccess.style.display = "none";
          errorMessage.textContent = message;
        }

        setTimeout(() => {
          alertSuccess.style.display = "none";
          alertError.style.display = "none";
        }, 5000);
      }

      // Check password strength
      newPasswordInput.addEventListener("input", () => {
        const password = newPasswordInput.value;
        const strength = checkPasswordStrength(password);

        // Update strength bar
        passwordStrength.style.width = strength.percent + "%";
        passwordStrength.style.backgroundColor = strength.color;
        strengthText.textContent = strength.text;

        // Update requirements checklist
        updateRequirements(password);
      });

      function checkPasswordStrength(password) {
        let strength = 0;

        if (password.length >= 8) strength += 25;
        if (/[a-z]/.test(password)) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 25;

        let text = "";
        let color = "";

        if (strength <= 25) {
          text = "Weak password";
          color = "#ef4444";
        } else if (strength <= 50) {
          text = "Fair password";
          color = "#f59e0b";
        } else if (strength <= 75) {
          text = "Good password";
          color = "#3b82f6";
        } else {
          text = "Strong password";
          color = "#10b981";
        }

        return { percent: strength, color, text };
      }

      function updateRequirements(password) {
        const requirements = {
          "req-length": password.length >= 8,
          "req-uppercase": /[A-Z]/.test(password),
          "req-lowercase": /[a-z]/.test(password),
          "req-number": /[0-9]/.test(password),
        };

        for (const [id, met] of Object.entries(requirements)) {
          const element = document.getElementById(id);
          const icon = element.querySelector("i");
          if (met) {
            icon.className = "fas fa-check-circle text-green-500 mr-2";
            icon.style.fontSize = "12px";
          } else {
            icon.className = "fas fa-circle text-gray-400 mr-2";
            icon.style.fontSize = "6px";
          }
        }
      }

      // Handle form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Validate inputs
        if (newPassword !== confirmPassword) {
          showAlert("error", "New passwords do not match");
          return;
        }

        if (newPassword.length < 8) {
          showAlert("error", "Password must be at least 8 characters");
          return;
        }

        // Validate password strength
        if (
          !/[A-Z]/.test(newPassword) ||
          !/[a-z]/.test(newPassword) ||
          !/[0-9]/.test(newPassword)
        ) {
          showAlert(
            "error",
            "Password must contain uppercase, lowercase, and number",
          );
          return;
        }

        // Show loading
        changePasswordButton.disabled = true;
        changePasswordButton.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
        loadingSpinner.classList.remove("hidden");

        try {
          // Call change password function
          const { data, error } = await supabase.rpc("change_password", {
            p_user_id: user.user_id,
            p_old_password: currentPassword,
            p_new_password: newPassword,
          });

          if (error) {
            throw error;
          }

          // Check if password change was successful
          if (!data || data.length === 0 || !data[0].success) {
            throw new Error(data[0]?.message || "Failed to change password");
          }

          // Clear temporary user
          sessionStorage.removeItem("temp_user");

          // Store user session
          const sessionData = {
            user_id: user.user_id,
            email: user.email,
            full_name: user.full_name,
            role_name: user.role_name,
            coach_id: user.coach_id,
            athlete_uid: user.athlete_uid,
            logged_in_at: new Date().toISOString(),
          };

          localStorage.setItem("akura_user", JSON.stringify(sessionData));

          // Show success message
          showAlert("success", "Password changed successfully! Redirecting...");

          // Redirect after 2 seconds
          setTimeout(() => {
            const dashboardMap = {
              admin: "/admin-dashboard.html",
              coach: "/coach-dashboard.html",
              athlete: "/athlete-dashboard.html",
            };
            window.location.href =
              dashboardMap[user.role_name] || "/athlete-dashboard.html";
          }, 2000);
        } catch (err) {
          console.error("Password change error:", err);
          showAlert(
            "error",
            err.message || "An error occurred while changing password",
          );

          // Reset button
          changePasswordButton.disabled = false;
          changePasswordButton.innerHTML =
            '<i class="fas fa-check mr-2"></i>Change Password';
          loadingSpinner.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
