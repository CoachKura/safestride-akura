<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strava OAuth Callback - SafeStride</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .container {
        background: white;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 48px 40px;
        max-width: 700px;
        width: 100%;
      }
      h1 {
        color: #f97316;
        margin-bottom: 16px;
        font-size: 28px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .status {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-size: 14px;
      }
      .loading {
        background: #fef3c7;
        color: #92400e;
        border-left: 4px solid #f59e0b;
      }
      .success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
      }
      .error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid #ef4444;
      }
      .data {
        background: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
      }
      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #f97316;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .button {
        display: inline-block;
        background: #f97316;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        margin-top: 16px;
        transition: background 0.3s;
        font-weight: 600;
      }
      .button:hover {
        background: #ea580c;
      }
      .profile {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 20px 0;
        padding: 16px;
        background: #f9fafb;
        border-radius: 12px;
      }
      .profile img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #f97316;
      }
      .profile-info {
        flex: 1;
      }
      .profile-info h3 {
        font-size: 18px;
        color: #111827;
        margin-bottom: 4px;
      }
      .profile-info p {
        font-size: 14px;
        color: #6b7280;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin: 20px 0;
      }
      .stat {
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-label {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéâ Strava Authentication</h1>
      <div id="status" class="status loading">
        <div class="spinner"></div>
        <p>Processing your Strava authorization...</p>
      </div>
      <div id="result"></div>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:8002"
          : "https://api.akura.in";

      async function handleCallback() {
        const statusDiv = document.getElementById("status");
        const resultDiv = document.getElementById("result");

        // Get authorization code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const error = urlParams.get("error");

        console.log("URL params:", Object.fromEntries(urlParams));
        console.log("Authorization code:", code);

        if (error) {
          statusDiv.className = "status error";
          statusDiv.innerHTML = `<p>‚ùå Authorization failed: ${error}</p>`;
          resultDiv.innerHTML =
            '<a href="signup-local.html" class="button">Try Again</a>';
          return;
        }

        if (!code) {
          statusDiv.className = "status error";
          statusDiv.innerHTML = "<p>‚ùå No authorization code received</p>";
          resultDiv.innerHTML = `
                    <p style="margin-top: 12px; color: #6b7280;">
                        If you just authorized, make sure your Strava app callback URL includes:<br>
                        <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${window.location.origin}/strava-callback-local.html
                        </code>
                    </p>
                    <a href="signup-local.html" class="button">Try Again</a>
                `;
          return;
        }

        try {
          console.log("Sending code to API:", code);

          // Exchange code for user account
          const response = await fetch(`${API_URL}/api/strava-signup`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ code }),
          });

          console.log("API Response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("API Error:", errorData);
            throw new Error(errorData.detail || "Signup failed");
          }

          const data = await response.json();
          console.log("Success! User data:", data);

          // Success!
          statusDiv.className = "status success";
          statusDiv.innerHTML = `
                    <p style="font-size: 16px; font-weight: 600;">‚úÖ ${data.message}</p>
                `;

          // Show profile
          resultDiv.innerHTML = `
                    <div class="profile">
                        <img src="${data.athlete.profile || "https://via.placeholder.com/60"}" alt="Profile">
                        <div class="profile-info">
                            <h3>${data.athlete.firstname} ${data.athlete.lastname}</h3>
                            <p>Strava ID: ${data.athlete.id}</p>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 24px; margin-bottom: 12px; color: #374151;">‚úÖ Account Created</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">
                        Your SafeStride account has been created and linked to your Strava profile!
                    </p>
                    
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: #6b7280; font-size: 14px; user-select: none;">
                            üìã View Raw Response Data
                        </summary>
                        <div class="data" style="margin-top: 12px;">${JSON.stringify(data, null, 2)}</div>
                    </details>
                    
                    <div id="syncSection" style="margin-top: 20px; padding: 16px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
                        <p style="color: #166534; font-size: 14px; margin-bottom: 10px;">‚è≥ Activities syncing in background (30-60 sec). Or sync now:</p>
                        <button id="syncBtn" onclick="syncActivities('${data.athlete.id}', '${data.access_token}')" 
                            style="background:#16a34a;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">
                            üîÑ Sync Activities Now
                        </button>
                        <div id="syncStatus" style="margin-top:8px;font-size:13px;color:#374151;"></div>
                    </div>

                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
                        <a href="signup-local.html" class="button" style="background: #6b7280;">Test Again</a>
                        <a href="http://localhost:8002/docs" class="button" target="_blank">API Docs</a>
                    </div>
                `;

          // Store user data in localStorage
          localStorage.setItem("safestride_user", JSON.stringify(data));
          localStorage.setItem("safestride_access_token", data.access_token);

          // Auto-load stats ‚Äî background sync runs on signup, try immediately
          // then retry at 40s in case background sync is still in progress
          const _aid = String(data.athlete.id);
          setTimeout(() => showStats(_aid), 3000);
          setTimeout(() => showStats(_aid, true), 40000);
        } catch (error) {
          console.error("Error during signup:", error);
          statusDiv.className = "status error";
          statusDiv.innerHTML = `
                    <p><strong>‚ùå Error:</strong> ${error.message}</p>
                    <p style="margin-top: 8px; font-size: 12px;">Check the browser console for details.</p>
                `;
          resultDiv.innerHTML = `
                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer;">View Error Details</summary>
                        <div class="data" style="margin-top: 12px;">${error.stack || error.toString()}</div>
                    </details>
                    <a href="signup-local.html" class="button">Try Again</a>
                `;
        }
      }

      function fmtTime(secs) {
        if (!secs) return "‚Äî";
        const h = Math.floor(secs / 3600),
          m = Math.floor((secs % 3600) / 60),
          s = Math.round(secs % 60);
        return h > 0
          ? `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`
          : `${m}:${String(s).padStart(2, "0")}`;
      }

      function fmtPace(secPerKm) {
        if (!secPerKm) return "‚Äî";
        return `${Math.floor(secPerKm / 60)}:${String(Math.round(secPerKm % 60)).padStart(2, "0")} /km`;
      }

      async function showStats(athleteId, silent) {
        const syncSection = document.getElementById("syncSection");
        if (!syncSection) return;
        try {
          if (!silent) {
            syncSection.innerHTML = `<p style="color:#166534;font-size:14px">‚è≥ Loading your stats...</p>`;
          }
          const r = await fetch(`${API_URL}/api/athlete-stats/${athleteId}`);
          if (!r.ok) {
            if (!silent)
              syncSection.innerHTML = `<p style="color:#dc2626;font-size:14px">Could not load stats. <button onclick="syncActivities('${athleteId}', localStorage.getItem('safestride_access_token'))" style="background:#16a34a;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer">Sync Now</button></p>`;
            return;
          }
          const d = await r.json();
          // Only update if stats exist (avoid replacing existing stats with empty data)
          if (!d.total_runs && !d.pb_5k && silent) return;
          syncSection.innerHTML = `
            <div style="margin-top:24px">
              <h3 style="color:#1e3a5f;margin-bottom:12px">üèÉ Your Running Stats</h3>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px">
                <div style="background:#f0f9ff;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.6rem;font-weight:700;color:#0369a1">${d.total_runs ?? "‚Äî"}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Total Runs</div>
                </div>
                <div style="background:#f0f9ff;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.6rem;font-weight:700;color:#0369a1">${d.total_distance_km ? d.total_distance_km.toFixed(1) : "‚Äî"}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Total km</div>
                </div>
                <div style="background:#f0f9ff;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.6rem;font-weight:700;color:#0369a1">${d.longest_run_km ? d.longest_run_km.toFixed(1) : "‚Äî"}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Longest Run (km)</div>
                </div>
                <div style="background:#f0f9ff;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.6rem;font-weight:700;color:#0369a1">${fmtPace(d.avg_pace_min_per_km ? d.avg_pace_min_per_km * 60 : null)}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Avg Pace</div>
                </div>
              </div>
              <h3 style="color:#1e3a5f;margin-bottom:12px">üèÖ Personal Bests</h3>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:700;color:#b45309">${fmtTime(d.pb_5k)}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">5K</div>
                </div>
                <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:700;color:#b45309">${fmtTime(d.pb_10k)}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">10K</div>
                </div>
                <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:700;color:#b45309">${fmtTime(d.pb_half_marathon)}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Half Marathon</div>
                </div>
                <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:700;color:#b45309">${fmtTime(d.pb_marathon)}</div>
                  <div style="font-size:0.8rem;color:#64748b;margin-top:2px">Marathon</div>
                </div>
              </div>
              <p style="color:#64748b;font-size:0.82rem;margin-top:16px;text-align:center">
                Stats calculated from your Strava activity history
              </p>
            </div>
          `;
        } catch (e) {
          console.error("showStats error:", e);
        }
      }

      async function syncActivities(athleteId, accessToken) {
        const btn = document.getElementById("syncBtn");
        const status = document.getElementById("syncStatus");
        btn.disabled = true;
        btn.textContent = "‚è≥ Syncing...";
        status.textContent = "Fetching your runs from Strava...";
        try {
          const resp = await fetch(`${API_URL}/api/strava-sync-activities`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              strava_athlete_id: String(athleteId),
              access_token: accessToken,
            }),
          });
          const result = await resp.json();
          if (resp.ok) {
            btn.textContent = "‚úÖ Synced!";
            btn.style.background = "#15803d";
            status.innerHTML =
              '<strong style="color:#166534">‚úÖ Sync complete! Loading your stats...</strong>';
            await showStats(athleteId);
          } else {
            btn.textContent = "‚ùå Sync Failed";
            btn.style.background = "#dc2626";
            status.textContent =
              "Error: " + (result.detail || JSON.stringify(result));
            btn.disabled = false;
          }
        } catch (e) {
          btn.textContent = "‚ùå Error";
          btn.style.background = "#dc2626";
          status.textContent = e.message;
          btn.disabled = false;
        }
      }

      // Run on page load
      handleCallback();
    </script>
  </body>
</html>
