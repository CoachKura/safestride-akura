<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AKURA Initial Assessment - SafeStride</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/responsive.css">
  
  <style>
    /* Assessment-Specific Styles */
    .assessment-nav {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5588 100%);
      color: white;
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
    }

    .assessment-nav-title {
      font-size: var(--font-size-h2);
      font-weight: var(--font-weight-bold);
      margin: 0;
    }

    .assessment-container {
      max-width: 900px;
      margin: var(--spacing-xl) auto;
      padding: var(--spacing-md);
    }

    .step-container {
      display: none;
    }

    .step-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-lg);
      border-bottom: 2px solid #e0e0e0;
    }

    .step-icon {
      font-size: 36px;
      color: var(--primary-teal);
      min-width: 50px;
      text-align: center;
    }

    .step-title-group h2 {
      margin: 0 0 4px 0;
      font-size: var(--font-size-h3);
      color: var(--primary-navy);
    }

    .step-description {
      font-size: var(--font-size-small);
      color: #666;
      margin: 0;
    }

    .visual-guide {
      margin: var(--spacing-lg) 0;
      text-align: center;
    }

    .visual-guide-image {
      max-width: 100%;
      height: auto;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: transform var(--transition-normal);
    }

    .visual-guide-image:hover {
      transform: scale(1.05);
    }

    .visual-guide-label {
      font-size: var(--font-size-small);
      color: #666;
      margin-top: 8px;
      font-style: italic;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-lg);
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-xl);
    }

    .modal-close {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      transition: color var(--transition-fast);
    }

    .modal-close:hover {
      color: var(--danger-red);
    }

    .modal-image {
      max-width: 100%;
      height: auto;
    }

    .measurements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }

    .review-section {
      background-color: #f9f9f9;
      border-left: 4px solid var(--primary-teal);
      padding: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
      border-radius: var(--border-radius-md);
    }

    .review-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid #e0e0e0;
    }

    .review-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .review-label {
      font-weight: var(--font-weight-semibold);
      color: var(--primary-navy);
    }

    .review-value {
      color: var(--primary-teal);
      font-weight: var(--font-weight-semibold);
    }

    .fms-score-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--spacing-md);
      margin: var(--spacing-lg) 0;
    }

    .fms-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .fms-item-label {
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      color: var(--primary-navy);
      margin-bottom: 8px;
    }

    .fms-item input {
      width: 100%;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .alignment-info {
      background: rgba(51, 190, 243, 0.1);
      border-left: 4px solid var(--primary-teal);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      margin: var(--spacing-lg) 0;
      font-size: var(--font-size-small);
      color: #333;
    }

    .success-message {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success-green);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-md);
      margin: var(--spacing-lg) 0;
      text-align: center;
    }

    .success-icon {
      font-size: 48px;
      color: var(--success-green);
      margin-bottom: var(--spacing-md);
    }

    .success-title {
      font-size: var(--font-size-h3);
      color: var(--success-green);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-md);
    }

    .success-text {
      color: #333;
      margin-bottom: var(--spacing-lg);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e0e0e0;
      border-top-color: var(--primary-teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .assessment-subtitle {
      margin: 8px 0 0 0;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
    }

    .progress-initial {
      width: calc(100% / 9);
    }

    .visual-guide-image-sm {
      max-height: 200px;
    }

    .readonly-input {
      background-color: #f0f0f0;
    }

    .pain-range-input {
      cursor: pointer;
    }

    .pain-scale {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .results-container {
      text-align: center;
      padding: var(--spacing-lg);
    }

    .results-loading {
      margin: var(--spacing-lg) 0;
    }

    .results-loading-text {
      margin-top: var(--spacing-md);
      color: #666;
    }

    .pillar-breakdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }

    .hidden {
      display: none;
    }

    .form-actions-center {
      text-align: center;
      flex: 1;
    }

    .step-counter {
      font-size: 14px;
      color: #666;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
  <!-- Navigation -->
  <div class="assessment-nav">
    <div class="container">
      <h1 class="assessment-nav-title">
        <i class="fas fa-heartbeat"></i> AKURA Initial Assessment
      </h1>
      <p class="assessment-subtitle">
        Complete your personal fitness assessment in 9 steps. Takes approximately 15-20 minutes.
      </p>
    </div>
  </div>

  <!-- Main Container -->
  <div class="assessment-container">
    <!-- Form -->
    <form id="assessmentForm" class="form-container">
      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-bar-fill progress-initial" id="progressBarFill"></div>
        </div>
        <div class="progress-steps" id="progressSteps">
          <!-- Dynamically populated -->
        </div>
      </div>

      <!-- STEP 1: Personal Profile -->
      <div class="step-container active" data-step="1">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-user"></i>
            </div>
            <div class="step-title-group">
              <h2>Personal Profile</h2>
              <p class="step-description">Let's start with your basic information</p>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">First Name</label>
              <input type="text" name="firstName" id="firstName" class="input-field" placeholder="John" required>
              <div class="validation-message"></div>
            </div>
            <div class="form-group required">
              <label class="form-group-label">Last Name</label>
              <input type="text" name="lastName" id="lastName" class="input-field" placeholder="Smith" required>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">Email</label>
              <input type="email" name="email" id="email" class="input-field" placeholder="john@example.com" required>
              <div class="validation-message"></div>
            </div>
            <div class="form-group required">
              <label class="form-group-label">Age</label>
              <input type="number" name="age" id="age" class="input-field" min="18" max="120" placeholder="30" required>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">Gender</label>
              <select name="gender" id="gender" class="input-field select-field" aria-label="Select your gender" required>
                <option value="">Select gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
              <div class="validation-message"></div>
            </div>
            <div class="form-group required">
              <label class="form-group-label">Primary Sport/Activity</label>
              <input type="text" name="primarySport" id="primarySport" class="input-field" placeholder="Running, Cycling, etc." required>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">Height (cm)</label>
              <input type="number" name="height" id="height" class="input-field" min="100" max="250" placeholder="180" required>
              <div class="validation-message"></div>
            </div>
            <div class="form-group required">
              <label class="form-group-label">Weight (kg)</label>
              <input type="number" name="weight" id="weight" class="input-field" min="30" max="200" placeholder="75" required>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-group required">
            <label class="form-group-label">Fitness Goals</label>
            <textarea name="fitnessGoals" id="fitnessGoals" class="input-field textarea" placeholder="What do you want to achieve with your training?" required></textarea>
            <div class="validation-message"></div>
          </div>
        </div>
      </div>

      <!-- STEP 2: Medical History -->
      <div class="step-container" data-step="2">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="step-title-group">
              <h2>Medical & Injury History</h2>
              <p class="step-description">Help us understand your health background</p>
            </div>
          </div>

          <div class="alignment-info">
            <strong>Why we ask:</strong> This helps us identify training modifications and injury prevention strategies specific to your needs.
          </div>

          <div class="form-group">
            <label class="form-group-label">Past Injuries</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="injury_ankle" name="injuries" value="ankle" class="checkbox-input">
                <label for="injury_ankle" class="checkbox-label">Ankle</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="injury_knee" name="injuries" value="knee" class="checkbox-input">
                <label for="injury_knee" class="checkbox-label">Knee</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="injury_hip" name="injuries" value="hip" class="checkbox-input">
                <label for="injury_hip" class="checkbox-label">Hip</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="injury_back" name="injuries" value="back" class="checkbox-input">
                <label for="injury_back" class="checkbox-label">Lower Back</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="injury_shoulder" name="injuries" value="shoulder" class="checkbox-input">
                <label for="injury_shoulder" class="checkbox-label">Shoulder</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="injury_other" name="injuries" value="other" class="checkbox-input">
                <label for="injury_other" class="checkbox-label">Other</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Injury Details</label>
            <textarea name="injuryDetails" id="injuryDetails" class="input-field textarea" placeholder="Describe any recurring issues, timeline, severity, etc."></textarea>
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Medical Conditions</label>
            <textarea name="medicalConditions" id="medicalConditions" class="input-field textarea" placeholder="Asthma, diabetes, heart conditions, etc."></textarea>
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Current Medications</label>
            <textarea name="medications" id="medications" class="input-field textarea" placeholder="List any medications you take regularly"></textarea>
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Surgeries</label>
            <textarea name="surgeries" id="surgeries" class="input-field textarea" placeholder="Any past surgeries? Include date and what was done."></textarea>
            <div class="validation-message"></div>
          </div>
        </div>
      </div>

      <!-- STEP 3: Body Type & Alignment -->
      <div class="step-container" data-step="3">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-body"></i>
            </div>
            <div class="step-title-group">
              <h2>Body Type & Alignment</h2>
              <p class="step-description">Assess your structural characteristics</p>
            </div>
          </div>

          <div class="visual-guide">
            <img src="https://www.genspark.ai/api/files/s/9U2Nk3uB" alt="Body Alignment Assessment" class="visual-guide-image" onclick="showModal(this.src, this.alt)">
            <p class="visual-guide-label">Click to enlarge reference image</p>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">Body Type</label>
              <select name="bodyType" id="bodyType" class="input-field select-field" required>
                <option value="">Select body type</option>
                <option value="ectomorph">Ectomorph (Lean & Tall)</option>
                <option value="mesomorph">Mesomorph (Athletic & Muscular)</option>
                <option value="endomorph">Endomorph (Rounder)</option>
              </select>
              <div class="validation-message"></div>
            </div>
            <div class="form-group">
              <label class="form-group-label">Pelvic Tilt</label>
              <select name="pelvisTilt" id="pelvisTilt" class="input-field select-field">
                <option value="neutral">Neutral</option>
                <option value="anterior">Anterior (Arched Lower Back)</option>
                <option value="posterior">Posterior (Tucked Under)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-group-label">Q-Angle Left Knee (degrees)</label>
              <input type="number" name="qAngleLeft" id="qAngleLeft" class="input-field" min="0" max="40" placeholder="0-40Â°" step="0.5">
              <p class="form-group-hint">Ideal: 10-15Â°</p>
              <div class="validation-message"></div>
            </div>
            <div class="form-group">
              <label class="form-group-label">Q-Angle Right Knee (degrees)</label>
              <input type="number" name="qAngleRight" id="qAngleRight" class="input-field" min="0" max="40" placeholder="0-40Â°" step="0.5">
              <p class="form-group-hint">Ideal: 10-15Â°</p>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-group-label">Navicular Drop (mm)</label>
              <input type="number" name="navicularDrop" id="navicularDrop" class="input-field" min="0" max="30" placeholder="0-30mm" step="0.5">
              <p class="form-group-hint">Foot pronation: 0-5 normal, 5-10 moderate, 10+ severe</p>
              <div class="validation-message"></div>
            </div>
            <div class="form-group">
              <label class="form-group-label">Head Posture</label>
              <select name="forwardHeadPosture" id="forwardHeadPosture" class="input-field select-field">
                <option value="neutral">Neutral</option>
                <option value="mild">Mild Forward Head</option>
                <option value="moderate">Moderate Forward Head</option>
                <option value="severe">Severe Forward Head</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Scoliosis or Spine Curvature</label>
            <select name="scoliosis" id="scoliosis" class="input-field select-field">
              <option value="no">No</option>
              <option value="minor">Minor</option>
              <option value="yes">Yes</option>
            </select>
            <div class="validation-message"></div>
          </div>
        </div>
      </div>

      <!-- STEP 4: Range of Motion Measurements -->
      <div class="step-container" data-step="4">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-expand"></i>
            </div>
            <div class="step-title-group">
              <h2>Range of Motion</h2>
              <p class="step-description">Measure your flexibility at key joints</p>
            </div>
          </div>

          <div class="alignment-info">
            <strong>How to measure:</strong> Click the images below for proper technique. Use a goniometer if possible, or estimate carefully.
          </div>

          <div class="measurements-grid">
            <div class="form-group">
              <label class="form-group-label">Ankle Dorsiflexion (degrees)</label>
              <input type="number" name="ankleFlexibility" id="ankleFlexibility" class="input-field" min="0" max="45" placeholder="0-45Â°" step="0.5" required>
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/miOAuJZv" alt="Ankle Dorsiflexion" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Hip Flexibility Sit & Reach (cm)</label>
              <input type="number" name="hipFlexibility" id="hipFlexibility" class="input-field" min="-20" max="50" placeholder="-20 to +50" step="0.5" required>
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/YEHmWZgi" alt="Sit and Reach" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Cervical ROM (degrees)</label>
              <input type="number" name="cervicalRom" id="cervicalRom" class="input-field" min="0" max="90" placeholder="0-90Â°" step="0.5">
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/RjjFnyxK" alt="Cervical ROM" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Shoulder ROM (degrees)</label>
              <input type="number" name="shoulderRom" id="shoulderRom" class="input-field" min="0" max="180" placeholder="0-180Â°" step="0.5">
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/sDu7IRKk" alt="Shoulder ROM" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Hip ROM (degrees)</label>
              <input type="number" name="hipRom" id="hipRom" class="input-field" min="0" max="180" placeholder="0-180Â°" step="0.5">
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/YF9kaORC" alt="Hip ROM" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Knee ROM (degrees)</label>
              <input type="number" name="kneeRom" id="kneeRom" class="input-field" min="0" max="150" placeholder="0-150Â°" step="0.5">
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/DWdI5vkv" alt="Knee ROM" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <div class="validation-message"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 5: FMS 7 Patterns -->
      <div class="step-container" data-step="5">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-person-walking"></i>
            </div>
            <div class="step-title-group">
              <h2>FMS 7 Movement Patterns</h2>
              <p class="step-description">Functional Movement Screen (0=cannot perform, 1=poor, 2=adequate, 3=excellent)</p>
            </div>
          </div>

          <div class="visual-guide">
            <img src="https://www.genspark.ai/api/files/s/V20x162Z" alt="FMS 7 Patterns" class="visual-guide-image" onclick="showModal(this.src, this.alt)">
            <p class="visual-guide-label">Click to enlarge FMS reference guide</p>
          </div>

          <div class="fms-score-display">
            <div class="fms-item">
              <div class="fms-item-label">Deep Squat</div>
              <input type="number" name="fmsDeepSquat" id="fmsDeepSquat" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Hurdle Step</div>
              <input type="number" name="fmsHurdleStep" id="fmsHurdleStep" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Shoulder Mobility</div>
              <input type="number" name="fmsShoulderMobility" id="fmsShoulderMobility" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Active Leg Raise</div>
              <input type="number" name="fmsActiveLegRaise" id="fmsActiveLegRaise" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Pushup</div>
              <input type="number" name="fmsPushup" id="fmsPushup" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Rotary Stability</div>
              <input type="number" name="fmsRotaryStability" id="fmsRotaryStability" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
            <div class="fms-item">
              <div class="fms-item-label">Lunge</div>
              <input type="number" name="fmsLunge" id="fmsLunge" class="input-field" min="0" max="3" placeholder="0-3" step="1">
            </div>
          </div>

          <div class="form-group">
            <label class="form-group-label">FMS Total Score</label>
            <input type="number" id="fmsTotal" class="input-field readonly-input" min="0" max="21" readonly>
            <p class="form-group-hint">Automatically calculated: 0-21 (7 movements Ã— 3 points max)</p>
          </div>

          <div class="form-group">
            <label class="form-group-label">Movement Compensations or Limitations</label>
            <textarea name="fmsNotes" id="fmsNotes" class="input-field textarea" placeholder="Note any asymmetries, compensations, or limitations observed"></textarea>
          </div>
        </div>
      </div>

      <!-- STEP 6: Strength Testing -->
      <div class="step-container" data-step="6">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-dumbbell"></i>
            </div>
            <div class="step-title-group">
              <h2>Strength Tests</h2>
              <p class="step-description">Measure core and lower body strength</p>
            </div>
          </div>

          <div class="measurements-grid">
            <div class="form-group">
              <label class="form-group-label">Plank Hold Time (seconds)</label>
              <input type="number" name="plankTime" id="plankTime" class="input-field" min="0" max="300" placeholder="0-300 sec" step="1" required>
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/RbgNQk0p" alt="Plank Hold Test" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <p class="form-group-hint">Good: 120 sec, Excellent: 180+ sec</p>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Single-Leg Balance (seconds)</label>
              <input type="number" name="singleLegBalance" id="singleLegBalance" class="input-field" min="0" max="120" placeholder="0-120 sec" step="1" required>
              <div class="visual-guide">
                <img src="https://www.genspark.ai/api/files/s/HpvYAUbO" alt="Single-Leg Balance" class="visual-guide-image visual-guide-image-sm" onclick="showModal(this.src, this.alt)">
              </div>
              <p class="form-group-hint">Good: 60 sec, Excellent: 90+ sec</p>
              <div class="validation-message"></div>
            </div>

            <div class="form-group">
              <label class="form-group-label">Max Squats (reps or 1-minute count)</label>
              <input type="number" name="squats" id="squats" class="input-field" min="0" max="200" placeholder="0-200" step="1" required>
              <p class="form-group-hint">Number of proper squats you can perform</p>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Strength Assessment Notes</label>
            <textarea name="strengthNotes" id="strengthNotes" class="input-field textarea" placeholder="Any form issues, pain, or compensations noted during testing"></textarea>
          </div>
        </div>
      </div>

      <!-- STEP 7: Running Baseline -->
      <div class="step-container" data-step="7">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-shoe-prints"></i>
            </div>
            <div class="step-title-group">
              <h2>Running Baseline</h2>
              <p class="step-description">Establish your current running fitness level</p>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-group-label">Recent 5K Time (MM:SS)</label>
              <input type="text" name="raceTime5K" id="raceTime5K" class="input-field" placeholder="25:30" pattern="\d{1,2}:\d{2}">
              <p class="form-group-hint">Most recent 5K race or time trial</p>
              <div class="validation-message"></div>
            </div>
            <div class="form-group required">
              <label class="form-group-label">Weekly Mileage (km)</label>
              <input type="number" name="weeklyKm" id="weeklyKm" class="input-field" min="0" max="150" placeholder="0-150" step="1" required>
              <p class="form-group-hint">Average km run per week</p>
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group required">
              <label class="form-group-label">Years Running</label>
              <input type="number" name="runningYears" id="runningYears" class="input-field" min="0" max="60" placeholder="0-60" step="1" required>
              <p class="form-group-hint">Total years of running experience</p>
              <div class="validation-message"></div>
            </div>
            <div class="form-group">
              <label class="form-group-label">Running Days Per Week</label>
              <input type="number" name="runningDaysPerWeek" id="runningDaysPerWeek" class="input-field" min="0" max="7" placeholder="1-7" step="1">
              <div class="validation-message"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-group-label">GPS Watch / Tracker</label>
              <select name="gpsWatch" id="gpsWatch" class="input-field select-field">
                <option value="">Select device</option>
                <option value="garmin">Garmin</option>
                <option value="apple">Apple Watch</option>
                <option value="fitbit">Fitbit</option>
                <option value="strava">Strava (phone)</option>
                <option value="other">Other</option>
                <option value="none">None</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-group-label">Resting Heart Rate (bpm)</label>
              <input type="number" name="restingHR" id="restingHR" class="input-field" min="30" max="120" placeholder="60" step="1">
              <p class="form-group-hint">Measured first thing in morning</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Pain Level (0 = None, 10 = Severe)</label>
            <input type="range" name="painLevel" id="painLevel" min="0" max="10" value="0" class="input-field pain-range-input">
            <div class="pain-scale">
              <span>No Pain</span>
              <span id="painValueDisplay">0</span>
              <span>Severe Pain</span>
            </div>
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label class="form-group-label">Current Injuries or Limitations</label>
            <textarea name="currentLimitations" id="currentLimitations" class="input-field textarea" placeholder="Any current pain, niggles, or training restrictions"></textarea>
          </div>
        </div>
      </div>

      <!-- STEP 8: AIFRI Results -->
      <div class="step-container" data-step="8">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="step-title-group">
              <h2>Your AIFRI Score</h2>
              <p class="step-description">Personalized fitness assessment results</p>
            </div>
          </div>

          <div id="resultsContainer" class="results-container">
            <div class="results-loading">
              <div class="loading-spinner"></div>
              <p class="results-loading-text">Calculating your AIFRI score...</p>
            </div>
          </div>

          <div id="pillarBreakdown" class="pillar-breakdown-grid">
            <!-- Populated by JavaScript -->
          </div>

          <div class="visual-guide">
            <img src="https://www.genspark.ai/api/files/s/M3RvJpV0" alt="AIFRI Scoring System" class="visual-guide-image" onclick="showModal(this.src, this.alt)">
            <p class="visual-guide-label">AIFRI 6-Pillar Scoring System</p>
          </div>

          <div id="recommendationsContainer"></div>
        </div>
      </div>

      <!-- STEP 9: Review & Submit -->
      <div class="step-container" data-step="9">
        <div class="form-section">
          <div class="step-header">
            <div class="step-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="step-title-group">
              <h2>Review & Submit</h2>
              <p class="step-description">Confirm your assessment before submitting</p>
            </div>
          </div>

          <div id="reviewContainer"></div>

          <div class="alignment-info">
            <strong><i class="fas fa-lock"></i> Your Privacy:</strong> Your assessment data is encrypted and stored securely. Only coaches you explicitly authorize can view your results.
          </div>

          <div class="form-group">
            <div class="checkbox-item">
              <input type="checkbox" id="privacyConsent" name="privacyConsent" class="checkbox-input" required>
              <label for="privacyConsent" class="checkbox-label">
                I understand and accept the privacy terms and data handling practices
              </label>
            </div>
          </div>

          <div id="submitSuccess" class="success-message hidden">
            <div class="success-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="success-title">Assessment Complete!</div>
            <div class="success-text" id="successMessage"></div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="form-actions-left">
          <button type="button" class="form-button form-button-secondary hidden" id="prevBtn" onclick="changeStep(-1)">
            <i class="fas fa-arrow-left"></i> Previous
          </button>
        </div>
        <div class="form-actions-center">
          <span id="stepCounter" class="step-counter">Step <span id="currentStep">1</span> of 9</span>
        </div>
        <div class="form-actions-right">
          <button type="button" class="form-button form-button-primary" id="nextBtn" onclick="changeStep(1)">
            Next <i class="fas fa-arrow-right"></i>
          </button>
          <button type="submit" class="form-button form-button-primary hidden" id="submitBtn">
            Submit Assessment <i class="fas fa-check"></i>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <img id="modalImage" class="modal-image" src="" alt="">
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/api-client.js"></script>
  <script src="js/aifri-engine.js"></script>
  <script src="js/form-validator.js"></script>
  <script src="js/storage-manager.js"></script>

  <script>
    // Initialize
    const form = document.getElementById('assessmentForm');
    const validator = new FormValidator(form);
    const storage = new StorageManager();
    let currentStep = 1;
    const totalSteps = 9;

    // Initialize progress steps
    function initProgressSteps() {
      const container = document.getElementById('progressSteps');
      for (let i = 1; i <= totalSteps; i++) {
        const step = document.createElement('div');
        step.className = `progress-step ${i === 1 ? 'active' : ''}`;
        step.innerHTML = `
          <div class="progress-step-circle">${i}</div>
          <div class="progress-step-label">Step ${i}</div>
        `;
        container.appendChild(step);
      }
    }

    // Update progress bar
    function updateProgress() {
      const percentage = (currentStep / totalSteps) * 100;
      document.getElementById('progressBarFill').style.width = percentage + '%';
      document.getElementById('currentStep').textContent = currentStep;

      // Update step indicators
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 === currentStep) {
          step.classList.add('active');
        } else if (index + 1 < currentStep) {
          step.classList.add('completed');
        }
      });

      // Update button visibility
      document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
      document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';
      document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';
    }

    // Change step
    window.changeStep = function(direction) {
      const newStep = currentStep + direction;
      if (newStep < 1 || newStep > totalSteps) return;

      // Validate current step before moving
      if (direction > 0 && currentStep !== totalSteps) {
        const stepElement = document.querySelector(`[data-step="${currentStep}"]`);
        const validation = validator.validateStep(stepElement);
        if (!validation.valid) {
          alert('Please complete required fields on this step.');
          return;
        }
      }

      currentStep = newStep;
      updateProgress();
    };

    // ============================================
    // ASSESSMENT FORM SUBMISSION HANDLER
    // ============================================

    function showLoadingSpinner(message = 'Processing...') {
      const btn = document.getElementById('submitBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = `<div class="loading-spinner"></div> ${message}`;
      }
    }

    function hideLoadingSpinner() {
      const btn = document.getElementById('submitBtn');
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = 'Submit Assessment <i class="fas fa-check"></i>';
      }
    }

    function showSuccessMessage(message) { alert(message); }
    function showErrorMessage(message) { alert(message); }

    function calculateAIFRIScore(assessmentData) {
      const res = JSON.parse(sessionStorage.getItem('aifriResult') || 'null');
      return res && typeof res.total === 'number' ? res.total : 70;
    }

    async function submitAssessment(assessmentData) {
      return akuraAPI.submitAssessment(assessmentData);
    }

    async function handleAssessmentSubmission(event) {
      event.preventDefault();

      if (!document.getElementById('privacyConsent').checked) {
        alert('Please accept the privacy terms to submit.');
        return;
      }

      console.log('ðŸ“‹ Collecting assessment data...');

      // Build assessment data mapped to existing fields
      const firstName = document.getElementById('firstName')?.value || '';
      const lastName = document.getElementById('lastName')?.value || '';

      const assessmentData = {
        personal: {
          name: `${firstName} ${lastName}`.trim(),
          age: parseInt(document.getElementById('age')?.value || '0'),
          gender: document.getElementById('gender')?.value || '',
          height: parseFloat(document.getElementById('height')?.value || '0'),
          weight: parseFloat(document.getElementById('weight')?.value || '0'),
          email: document.getElementById('email')?.value || '',
          phone: '',
          primarySport: document.getElementById('primarySport')?.value || '',
          goals: document.getElementById('fitnessGoals')?.value || ''
        },

        medical: {
          injuries: Array.from(document.querySelectorAll('input[name="injuries"]:checked')).map(el => el.value),
          conditions: (document.getElementById('medicalConditions')?.value || '').split(',').map(s => s.trim()).filter(Boolean),
          medications: document.getElementById('medications')?.value || '',
          surgeries: document.getElementById('surgeries')?.value || ''
        },

        alignment: {
          bodyType: document.getElementById('bodyType')?.value || 'mesomorph',
          qAngle: (() => {
            const l = parseFloat(document.getElementById('qAngleLeft')?.value || '0');
            const r = parseFloat(document.getElementById('qAngleRight')?.value || '0');
            const avg = (isNaN(l) ? null : l) !== null && (isNaN(r) ? null : r) !== null && l && r ? (l + r) / 2
              : (!isNaN(l) && l ? l : (!isNaN(r) && r ? r : 0));
            const num = parseFloat(avg);
            if (isNaN(num)) return 0;
            return Math.max(0, Math.min(45, num));
          })(),
          footPronation: (() => {
            const nd = parseFloat(document.getElementById('navicularDrop')?.value || '0');
            if (!nd) return 'neutral';
            if (nd >= 10) return 'overpronation';
            if (nd >= 5) return 'moderate';
            return 'neutral';
          })(),
          pelvicTilt: document.getElementById('pelvisTilt')?.value || 'neutral',
          forwardHead: document.getElementById('forwardHeadPosture')?.value || 'neutral'
        },

        rom: {
          cervical: parseFloat(document.getElementById('cervicalRom')?.value || '75'),
          shoulder: parseFloat(document.getElementById('shoulderRom')?.value || '85'),
          hip: parseFloat(document.getElementById('hipRom')?.value || '90'),
          knee: parseFloat(document.getElementById('kneeRom')?.value || '92'),
          ankle: parseFloat(document.getElementById('ankleFlexibility')?.value || '85')
        },

        fms: {
          deepSquat: parseInt(document.getElementById('fmsDeepSquat')?.value || '2'),
          hurdleStep: parseInt(document.getElementById('fmsHurdleStep')?.value || '2'),
          inlineLunge: parseInt(document.getElementById('fmsLunge')?.value || '2'),
          shoulderMobility: parseInt(document.getElementById('fmsShoulderMobility')?.value || '2'),
          legRaise: parseInt(document.getElementById('fmsActiveLegRaise')?.value || '2'),
          pushUp: parseInt(document.getElementById('fmsPushup')?.value || '2'),
          rotaryStability: parseInt(document.getElementById('fmsRotaryStability')?.value || '2'),
          totalScore: 0
        },

        strength: {
          plankHold: parseFloat(document.getElementById('plankTime')?.value || '60'),
          singleLegBalance: parseFloat(document.getElementById('singleLegBalance')?.value || '20'),
          calfRaises: null,
          singleLegSquat: ''
        },

        mobility: {
          sitReach: parseFloat(document.getElementById('hipFlexibility')?.value || '10'),
          ankleDorsiflex: parseFloat(document.getElementById('ankleFlexibility')?.value || '10'),
          hipFlexor: ''
        },

        running: {
          weeklyMileage: parseFloat(document.getElementById('weeklyKm')?.value || '25'),
          longRun: null,
          easyPace: '',
          tempoPace: '',
          vdot: 40,
          recentRace: document.getElementById('raceTime5K')?.value || ''
        },

        goals: {
          primary: document.getElementById('fitnessGoals')?.value || 'injury-prevention',
          targetRace: '',
          targetDate: '',
          experience: (() => {
            const yrs = parseInt(document.getElementById('runningYears')?.value || '0');
            if (yrs >= 5) return 'advanced';
            if (yrs >= 2) return 'intermediate';
            return 'beginner';
          })()
        }
      };

      // Balance aggregation
      const balance = {
        singleLegEyesOpen: assessmentData.strength.singleLegBalance,
        singleLegEyesClosed: parseFloat(document.getElementById('singleLegBalanceEyesClosed')?.value || '10'),
        fmsTotal: (
          assessmentData.fms.deepSquat +
          assessmentData.fms.hurdleStep +
          assessmentData.fms.inlineLunge +
          assessmentData.fms.shoulderMobility +
          assessmentData.fms.legRaise +
          assessmentData.fms.pushUp +
          assessmentData.fms.rotaryStability
        )
      };
      assessmentData.fms.totalScore = balance.fmsTotal;
      assessmentData.balance = balance;

      // AIFRI score (client-side)
      const aifriScore = calculateAIFRIScore(assessmentData);
      assessmentData.aifriScore = aifriScore;

      console.log('ðŸ“Š AIFRI Score calculated:', aifriScore);
      console.log('ðŸ“¦ Complete assessment data:', assessmentData);

      // Save local backup
      const formData = validator.getFormData();
      storage.saveAssessmentDraft(0, { ...formData, aifriResult: JSON.parse(sessionStorage.getItem('aifriResult') || 'null'), status: 'submitted' });

      // Show loading
      showLoadingSpinner('Analyzing your assessment and generating personalized protocol...');

      try {
        const result = await submitAssessment(assessmentData);

        localStorage.setItem('assessment', JSON.stringify(assessmentData));
        localStorage.setItem('aifriScore', String(result.aifriScore || aifriScore));
        if (result.protocolId) localStorage.setItem('protocolId', result.protocolId);
        if (result.assessmentId) localStorage.setItem('assessmentId', result.assessmentId);

        console.log('âœ… Assessment submitted successfully:', result);

        hideLoadingSpinner();
        showSuccessMessage('Assessment complete! Generating your personalized 90-day protocol...');

        setTimeout(() => {
          const pid = result.protocolId || localStorage.getItem('protocolId') || '';
          window.location.href = pid ? `training-plans.html?protocolId=${pid}` : 'training-plans.html';
        }, 2000);
      } catch (error) {
        console.error('âŒ Assessment submission failed:', error);
        hideLoadingSpinner();
        showErrorMessage(`Unable to connect to server: ${error.message}\n\nYour assessment has been saved locally. You can continue in offline mode.`);

        localStorage.setItem('assessment', JSON.stringify(assessmentData));
        localStorage.setItem('aifriScore', String(aifriScore));
        const tempProtocolId = `temp_${Date.now()}`;
        localStorage.setItem('protocolId', tempProtocolId);

        setTimeout(() => {
          const proceed = confirm('Continue to training plan in offline mode?');
          if (proceed) {
            window.location.href = `training-plans.html?protocolId=${tempProtocolId}`;
          }
        }, 3000);
      }
    }

    // Attach event listener
    document.addEventListener('DOMContentLoaded', () => {
      const assessmentForm = document.getElementById('assessmentForm');
      if (assessmentForm) {
        assessmentForm.addEventListener('submit', handleAssessmentSubmission);
      }
    });

    // Modal Functions
    window.showModal = function(src, alt) {
      document.getElementById('imageModal').classList.add('show');
      document.getElementById('modalImage').src = src;
      document.getElementById('modalImage').alt = alt;
    };

    window.closeModal = function() {
      document.getElementById('imageModal').classList.remove('show');
    };

    // Pain level sync
    document.getElementById('painLevel').addEventListener('input', function() {
      document.getElementById('painValueDisplay').textContent = this.value;
    });

    // FMS total auto-calculation
    function updateFmsTotal() {
      const fmsFields = ['fmsDeepSquat', 'fmsHurdleStep', 'fmsShoulderMobility', 'fmsActiveLegRaise', 'fmsPushup', 'fmsRotaryStability', 'fmsLunge'];
      let total = 0;
      fmsFields.forEach(field => {
        const value = parseInt(document.getElementById(field).value) || 0;
        total += value;
      });
      document.getElementById('fmsTotal').value = total;
    }

    document.querySelectorAll('[id^="fms"]').forEach(field => {
      if (field.id !== 'fmsTotal' && field.id !== 'fmsNotes') {
        field.addEventListener('input', updateFmsTotal);
      }
    });

    // Load draft if exists
    const draft = storage.loadAssessmentDraft();
    if (draft) {
      const resumeConfirm = confirm('You have a saved assessment from ' + new Date(draft.lastSaved).toLocaleString() + '. Resume?');
      if (resumeConfirm) {
        Object.keys(draft.formData).forEach(key => {
          const field = document.querySelector(`[name="${key}"]`);
          if (field) {
            if (field.type === 'checkbox') {
              field.checked = draft.formData[key];
            } else {
              field.value = draft.formData[key];
            }
          }
        });
        currentStep = draft.step;
        updateProgress();
      }
    }

    // Initialize
    initProgressSteps();
    updateProgress();
  </script>
</body>
</html>
