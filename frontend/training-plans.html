<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Protocol - AKURA SafeStride</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- CSS Framework -->
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/charts.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <style>
        :root {
            --primary: #1e3a5f;
            --secondary: #33BEF3;
            --success: #4CAF50;
            --warning: #FF9500;
            --danger: #FF6B6B;
            --info: #9C27B0;
        }

        body {
            background: #f8f9fa;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .header-nav {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            margin-right: 15px;
            font-weight: 600;
            transition: opacity 0.3s;
        }

        .header-nav a:hover {
            opacity: 0.7;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .protocol-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER CARD */
        .protocol-header {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .header-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .header-stat {
            border-left: 4px solid var(--secondary);
            padding-left: 15px;
        }

        .header-stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .header-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .header-stat-subtext {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .aifri-badge {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-left: 10px;
        }

        .protocol-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .protocol-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .protocol-info-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .progress-bar-container {
            flex: 1;
            max-width: 300px;
        }

        .progress-bar-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-custom {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 25%;
            transition: width 0.3s ease;
        }

        .timeline-dates {
            font-size: 13px;
            color: #999;
        }

        /* TABS */
        .tabs-container {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            text-align: center;
        }

        .tab-button:hover {
            background: #f8f9fa;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--secondary);
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* TAB 1: OVERVIEW */
        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .goal-card {
            background: linear-gradient(135deg, rgba(51, 190, 243, 0.05), rgba(30, 58, 95, 0.05));
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid var(--secondary);
        }

        .goal-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .goal-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .goal-item:last-child {
            border-bottom: none;
        }

        .goal-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .goal-value {
            font-size: 14px;
            color: var(--primary);
            font-weight: 700;
        }

        .pillar-targets {
            background: linear-gradient(135deg, rgba(51, 190, 243, 0.05), rgba(30, 58, 95, 0.05));
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid var(--warning);
        }

        .pillar-targets h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .pillar-row {
            margin-bottom: 20px;
        }

        .pillar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .pillar-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .pillar-bar-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .color-running { background: var(--primary); }
        .color-strength { background: var(--warning); }
        .color-rom { background: var(--secondary); }
        .color-balance { background: var(--success); }
        .color-mobility { background: var(--info); }
        .color-alignment { background: var(--danger); }

        .milestones {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .milestones h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .milestone-item {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .milestone-week {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            min-width: 60px;
            text-align: center;
        }

        .milestone-content {
            flex: 1;
        }

        .milestone-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .milestone-desc {
            font-size: 14px;
            color: #666;
        }

        .milestone-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
        }

        .milestone-status.completed {
            color: var(--success);
        }

        .milestone-status.upcoming {
            color: var(--warning);
        }

        /* TAB 2: WEEKLY BREAKDOWN */
        .accordion-item-custom {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .accordion-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 20px;
            background: white;
            border: none;
            cursor: pointer;
            text-align: left;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            transition: background 0.3s;
        }

        .accordion-toggle:hover {
            background: #f8f9fa;
        }

        .accordion-toggle.active {
            background: linear-gradient(135deg, rgba(51, 190, 243, 0.1), rgba(30, 58, 95, 0.1));
        }

        .accordion-toggle-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .accordion-toggle.active .accordion-toggle-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: 0 20px 20px;
            background: #fafafa;
        }

        .accordion-content.active {
            display: block;
        }

        .week-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .week-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
        }

        .week-stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
        }

        .week-stat-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
        }

        .workouts-list {
            display: grid;
            gap: 12px;
        }

        .workout-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workout-name {
            font-weight: 600;
            color: var(--primary);
        }

        .workout-detail {
            font-size: 13px;
            color: #666;
        }

        /* TAB 3: DAILY WORKOUTS */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            color: var(--primary);
            padding: 10px;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .calendar-day-empty {
            background: #f8f9fa;
            border: none;
            cursor: default;
        }

        .calendar-day-empty:hover {
            box-shadow: none;
            transform: none;
        }

        .calendar-day.easy {
            background: rgba(76, 175, 80, 0.15);
            border-color: #4CAF50;
        }

        .calendar-day.threshold {
            background: rgba(255, 149, 0, 0.15);
            border-color: #FF9500;
        }

        .calendar-day.long {
            background: rgba(30, 58, 95, 0.15);
            border-color: var(--primary);
        }

        .calendar-day.strength {
            background: rgba(156, 39, 176, 0.15);
            border-color: #9C27B0;
        }

        .calendar-day.rest {
            background: white;
            color: #999;
        }

        .calendar-day-number {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .calendar-day-type {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* MODAL */
        .modal-custom {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-custom.active {
            display: flex;
        }

        .modal-content-custom {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .workout-detail-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .workout-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .workout-detail-label {
            font-weight: 600;
            color: #666;
        }

        .workout-detail-value {
            font-weight: 700;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .header-grid {
                grid-template-columns: 1fr 1fr;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .tabs-container {
                flex-wrap: wrap;
                border-radius: 12px;
            }

            .tab-button {
                min-width: 80px;
                padding: 15px 10px;
                font-size: 13px;
            }

            .tab-content {
                padding: 20px;
            }
        }

        /* Utility Classes */
        .progress-secondary {
            color: var(--secondary);
        }

        .progress-width-0 {
            width: 0%;
        }

        .mb-24 {
            margin-bottom: 24px;
        }

        .week-label-muted {
            color: #999;
            font-weight: 400;
        }

        .status-success {
            color: #4CAF50;
        }

        .status-warning-arrow {
            color: var(--warning);
        }

        .workout-completed {
            background: #f0f0f0;
            opacity: 0.6;
        }

        .future-week-label {
            color: #999;
            font-weight: 400;
        }

        .future-weeks-grid {
            display: grid;
            gap: 12px;
        }

        .future-week-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
        }

        .section-heading-primary {
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 800;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: 40px;
        }

        .chart-caption {
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        .alert-box-info {
            background: #f0f8ff;
            border-left: 4px solid var(--secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-title-primary {
            color: var(--primary);
        }

        .alert-text {
            color: #666;
            margin-top: 8px;
            font-size: 14px;
        }

        .monitoring-grid {
            display: grid;
            gap: 15px;
        }

        .monitoring-card {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
        }

        .monitoring-warning {
            border-left: 4px solid var(--warning);
        }

        .monitoring-success {
            border-left: 4px solid var(--success);
        }

        .monitoring-info {
            border-left: 4px solid var(--info);
        }

        .monitoring-text {
            font-size: 13px;
            color: #666;
        }

        .modal-divider {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-success-full {
            background: var(--success);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .w-20 { width: 20%; }
        .w-25 { width: 25%; }
        .w-30 { width: 30%; }
        .w-35 { width: 35%; }
        .w-40 { width: 40%; }
        .w-45 { width: 45%; }

        .week-3-current {
            color: var(--secondary);
            font-weight: 800;
        }

        .week-description {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- NAVIGATION HEADER -->
    <div class="header-nav">
        <div class="protocol-container">
            <button class="back-button" onclick="history.back()">‚Üê Back</button>
        </div>
    </div>

    <div class="protocol-container">
        <!-- HEADER CARD -->
        <div class="protocol-header">
            <div class="header-grid">
                <div class="header-stat">
                    <div class="header-stat-label">Athlete</div>
                    <div class="header-stat-value" id="athleteName">Athlete</div>
                    <div class="header-stat-subtext" id="athleteId">ID: ‚Äî</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">AIFRI Score</div>
                    <div class="header-stat-value"><span id="aifriScore">‚Äî</span><span class="aifri-badge" id="aifriBadge">‚Äî</span></div>
                    <div class="header-stat-subtext">6-Pillar Assessment</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Body Type</div>
                    <div class="header-stat-value" id="bodyType">‚Äî</div>
                    <div class="header-stat-subtext">Balanced physique</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Goal</div>
                    <div class="header-stat-value" id="goalValue">‚Äî</div>
                    <div class="header-stat-subtext" id="goalSubtext">‚Äî</div>
                </div>
            </div>

            <div class="protocol-title" id="protocolTitle">Training Protocol</div>

            <div class="protocol-info-row">
                <div class="protocol-info-left">
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span id="progressWeek">Week ‚Äî / 12</span>
                            <span id="progressPercent" class="progress-secondary">‚Äî%</span>
                        </div>
                        <div class="progress-bar-custom">
                            <div class="progress-bar-fill progress-width-0" id="progressFill"></div>
                        </div>
                    </div>
                    <div class="timeline-dates" id="timelineDates">‚Äî</div>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab(event, 'overview')">Overview</button>
            <button class="tab-button" onclick="switchTab(event, 'weekly')">Weekly Breakdown</button>
            <button class="tab-button" onclick="switchTab(event, 'daily')">Daily Workouts</button>
            <button class="tab-button" onclick="switchTab(event, 'progress')">Progress Tracking</button>
            <button class="tab-button" onclick="switchTab(event, 'alerts')">Injury Alerts</button>
        </div>

        <!-- TAB 1: OVERVIEW -->
        <div id="overview" class="tab-content active">
            <div id="protocolOverview" class="mb-24"></div>
            <div class="overview-grid">
                <!-- GOAL SUMMARY -->
                <div class="goal-card">
                    <h3>Goal Summary</h3>
                    <div class="goal-item">
                        <span class="goal-label">Target Finish</span>
                        <span class="goal-value">3:55:00</span>
                    </div>
                    <div class="goal-item">
                        <span class="goal-label">Body Type</span>
                        <span class="goal-value">Mesomorph</span>
                    </div>
                    <div class="goal-item">
                        <span class="goal-label">Weekly Volume</span>
                        <span class="goal-value">30-50km</span>
                    </div>
                    <div class="goal-item">
                        <span class="goal-label">Key Focus</span>
                        <span class="goal-value">Running 40%</span>
                    </div>
                    <div class="goal-item">
                        <span class="goal-label">Secondary</span>
                        <span class="goal-value">Injury Prevention</span>
                    </div>
                </div>

                <!-- PILLAR TARGETS -->
                <div class="pillar-targets">
                    <h3>Pillar Progression Targets</h3>
                    
                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>üèÉ Running</span>
                            <span>75 ‚Üí 85</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-running w-30"></div>
                        </div>
                    </div>

                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>üí™ Strength</span>
                            <span>80 ‚Üí 88</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-strength w-40"></div>
                        </div>
                    </div>

                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>üîÑ ROM</span>
                            <span>70 ‚Üí 78</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-rom w-25"></div>
                        </div>
                    </div>

                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>‚öñÔ∏è Balance</span>
                            <span>85 ‚Üí 90</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-balance w-45"></div>
                        </div>
                    </div>

                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>üßò Mobility</span>
                            <span>65 ‚Üí 75</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-mobility w-20"></div>
                        </div>
                    </div>

                    <div class="pillar-row">
                        <div class="pillar-header">
                            <span>ü¶¥ Alignment</span>
                            <span>72 ‚Üí 80</span>
                        </div>
                        <div class="pillar-bar">
                            <div class="pillar-bar-fill color-alignment w-35"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MILESTONES TIMELINE -->
            <div class="milestones">
                <h3>Protocol Milestones</h3>
                
                <div class="milestone-item">
                    <div class="milestone-week">W4</div>
                    <div class="milestone-content">
                        <div class="milestone-title">First Assessment Checkpoint</div>
                        <div class="milestone-desc">Evaluate progress on pillar targets and adjust protocols if needed</div>
                    </div>
                    <div class="milestone-status completed">‚úì Completed</div>
                </div>

                <div class="milestone-item">
                    <div class="milestone-week">W8</div>
                    <div class="milestone-content">
                        <div class="milestone-title">Mid-Protocol Evaluation</div>
                        <div class="milestone-desc">Full AIFRI reassessment and protocol adaptation</div>
                    </div>
                    <div class="milestone-status upcoming">‚è≥ Upcoming (Feb 24)</div>
                </div>

                <div class="milestone-item">
                    <div class="milestone-week">W12</div>
                    <div class="milestone-content">
                        <div class="milestone-title">Final Assessment & Protocol Renewal</div>
                        <div class="milestone-desc">Graduation into next 90-day phase or racing preparation</div>
                    </div>
                    <div class="milestone-status upcoming">üìÖ Scheduled (Apr 27)</div>
                </div>
            </div>
        </div>

        <!-- TAB 2: WEEKLY BREAKDOWN -->
        <div id="weekly" class="tab-content">
            <div id="weeklyPlan"></div>
            <!-- WEEK 1 -->
            <div class="accordion-item-custom">
                <button class="accordion-toggle" onclick="toggleAccordion(event)">
                    <span>Week 1 - Base Building <span class="week-label-muted">32km</span></span>
                    <span class="accordion-toggle-icon">‚ñº</span>
                </button>
                <div class="accordion-content">
                    <div class="week-stats">
                        <div class="week-stat">
                            <div class="week-stat-label">Total Volume</div>
                            <div class="week-stat-value">32km</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Focus</div>
                            <div class="week-stat-value">Base</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Intensity</div>
                            <div class="week-stat-value">Moderate</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Status</div>
                            <div class="week-stat-value status-success">‚úì Done</div>
                        </div>
                    </div>
                    <div class="workouts-list">
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Monday - Strength</div>
                                <div class="workout-detail">Core + Lower Body (45 min)</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Tuesday - Easy Run</div>
                                <div class="workout-detail">5km @ Z2 (Easy)</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Wednesday - Threshold</div>
                                <div class="workout-detail">8km (3km @ Z4 Threshold)</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Thursday - Rest/Mobility</div>
                                <div class="workout-detail">20 min stretching & foam roll</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Friday - Easy Run</div>
                                <div class="workout-detail">5km @ Z2 (Easy)</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Saturday - Long Run</div>
                                <div class="workout-detail">12km @ Z2 (Aerobic Base)</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Sunday - Rest</div>
                                <div class="workout-detail">Complete rest day</div>
                            </div>
                            <div>‚úì</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WEEK 2 -->
            <div class="accordion-item-custom">
                <button class="accordion-toggle" onclick="toggleAccordion(event)">
                    <span>Week 2 - Endurance Foundation <span class="week-label-muted">35km</span></span>
                    <span class="accordion-toggle-icon">‚ñº</span>
                </button>
                <div class="accordion-content">
                    <div class="week-stats">
                        <div class="week-stat">
                            <div class="week-stat-label">Total Volume</div>
                            <div class="week-stat-value">35km</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Focus</div>
                            <div class="week-stat-value">Endurance</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Intensity</div>
                            <div class="week-stat-value">Moderate</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Status</div>
                            <div class="week-stat-value status-success">‚úì Done</div>
                        </div>
                    </div>
                    <p class="week-description">Similar structure to Week 1 with increased volume on long run (14km) and threshold work (10km @ Z4).</p>
                </div>
            </div>

            <!-- WEEK 3 (CURRENT) -->
            <div class="accordion-item-custom">
                <button class="accordion-toggle active" onclick="toggleAccordion(event)">
                    <span class="week-3-current">Week 3 - Aerobic Development <span class="week-label-muted">38km</span></span>
                    <span class="accordion-toggle-icon">‚ñº</span>
                </button>
                <div class="accordion-content active">
                    <div class="week-stats">
                        <div class="week-stat">
                            <div class="week-stat-label">Total Volume</div>
                            <div class="week-stat-value">38km</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Focus</div>
                            <div class="week-stat-value">Aerobic</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Completed</div>
                            <div class="week-stat-value">18.2km</div>
                        </div>
                        <div class="week-stat">
                            <div class="week-stat-label">Remaining</div>
                            <div class="week-stat-value status-warning-arrow">19.8km</div>
                        </div>
                    </div>
                    <div class="workouts-list">
                        <div class="workout-item workout-completed">
                            <div>
                                <div class="workout-name">Monday - Strength (Completed)</div>
                                <div class="workout-detail">Core + Single-leg focus (50 min)</div>
                            </div>
                            <div class="status-success">‚úì</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Wednesday - Threshold (Upcoming)</div>
                                <div class="workout-detail">10km (4km @ Z4 Threshold)</div>
                            </div>
                            <div class="status-warning-arrow">‚Üí</div>
                        </div>
                        <div class="workout-item">
                            <div>
                                <div class="workout-name">Saturday - Long Run (Upcoming)</div>
                                <div class="workout-detail">16km @ Z2 (Extended Aerobic)</div>
                            </div>
                            <div class="status-warning-arrow">‚Üí</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WEEKS 4-12 COLLAPSED -->
            <div class="accordion-item-custom">
                <button class="accordion-toggle" onclick="toggleAccordion(event)">
                    <span>Weeks 4-12 (Future) <span class="future-week-label">Collapsed View</span></span>
                    <span class="accordion-toggle-icon">‚ñº</span>
                </button>
                <div class="accordion-content">
                    <div class="future-weeks-grid">
                        <div class="future-week-card">
                            <strong>Week 4:</strong> Threshold Focus (40km) - Increase threshold duration
                        </div>
                        <div class="future-week-card">
                            <strong>Week 5:</strong> Speed Development (39km) - Introduce VO2max intervals
                        </div>
                        <div class="future-week-card">
                            <strong>Week 6:</strong> Recovery Week (32km) - Deload for adaptation
                        </div>
                        <div class="future-week-card">
                            <strong>Week 7:</strong> Long Run Emphasis (45km) - Build marathon-specific endurance
                        </div>
                        <div class="future-week-card">
                            <strong>Weeks 8-12:</strong> Tapering & Race Prep - Protocol will be adjusted based on Week 8 assessment
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: DAILY WORKOUTS -->
        <div id="daily" class="tab-content">
            <div id="dailyWorkouts"></div>
            <h3 class="section-heading-primary">February 2026 - Week 3</h3>
            <div class="calendar-grid">
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
                <div class="calendar-day-header">Sun</div>

                <!-- Weeks of January/February -->
                <div class="calendar-day easy" onclick="openWorkoutModal('Monday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">27</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day threshold" onclick="openWorkoutModal('Tuesday Threshold', '8km with 4km @ Z4')">
                    <div class="calendar-day-number">28</div>
                    <div class="calendar-day-type">Threshold</div>
                </div>
                <div class="calendar-day long" onclick="openWorkoutModal('Wednesday Long', '12km @ Z2 Aerobic Base')">
                    <div class="calendar-day-number">29</div>
                    <div class="calendar-day-type">Long Run</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">30</div>
                    <div class="calendar-day-type">Rest</div>
                </div>
                <div class="calendar-day easy" onclick="openWorkoutModal('Thursday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">31</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day strength" onclick="openWorkoutModal('Friday Strength', 'Core + Lower Body (45 min)')">
                    <div class="calendar-day-number">1</div>
                    <div class="calendar-day-type">Strength</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">2</div>
                    <div class="calendar-day-type">Rest</div>
                </div>

                <!-- Continue week -->
                <div class="calendar-day easy" onclick="openWorkoutModal('Monday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">3</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day threshold" onclick="openWorkoutModal('Tuesday Threshold', '10km with 4km @ Z4')">
                    <div class="calendar-day-number">4</div>
                    <div class="calendar-day-type">Threshold</div>
                </div>
                <div class="calendar-day long" onclick="openWorkoutModal('Wednesday Long', '14km @ Z2 Extended')">
                    <div class="calendar-day-number">5</div>
                    <div class="calendar-day-type">Long Run</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">6</div>
                    <div class="calendar-day-type">Rest</div>
                </div>
                <div class="calendar-day easy" onclick="openWorkoutModal('Thursday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">7</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day strength" onclick="openWorkoutModal('Friday Strength', 'Core + Hip Focus (45 min)')">
                    <div class="calendar-day-number">8</div>
                    <div class="calendar-day-type">Strength</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">9</div>
                    <div class="calendar-day-type">Rest</div>
                </div>

                <!-- Continue -->
                <div class="calendar-day easy" onclick="openWorkoutModal('Monday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">10</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day threshold" onclick="openWorkoutModal('Tuesday Tempo', '10km with 5km @ Z4')">
                    <div class="calendar-day-number">11</div>
                    <div class="calendar-day-type">Threshold</div>
                </div>
                <div class="calendar-day long" onclick="openWorkoutModal('Wednesday Long', '16km @ Z2 Marathon Pace')">
                    <div class="calendar-day-number">12</div>
                    <div class="calendar-day-type">Long Run</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">13</div>
                    <div class="calendar-day-type">Rest</div>
                </div>
                <div class="calendar-day easy" onclick="openWorkoutModal('Thursday Easy', '5km @ Z2 Easy pace')">
                    <div class="calendar-day-number">14</div>
                    <div class="calendar-day-type">Easy</div>
                </div>
                <div class="calendar-day strength" onclick="openWorkoutModal('Friday Strength', 'Single-leg Focus (50 min)')">
                    <div class="calendar-day-number">15</div>
                    <div class="calendar-day-type">Strength</div>
                </div>
                <div class="calendar-day rest">
                    <div class="calendar-day-number">16</div>
                    <div class="calendar-day-type">Rest</div>
                </div>
            </div>
        </div>

        <!-- TAB 4: PROGRESS TRACKING -->
        <div id="progress" class="tab-content">
            <h3 class="section-heading-primary">Pillar Progress vs Targets</h3>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
            <p class="chart-caption">
                Your current AIFRI 76 (ADVANCED) is trending toward protocol targets. Week 8 mid-assessment will validate progression.
            </p>
        </div>

        <!-- TAB 5: INJURY ALERTS -->
        <div id="alerts" class="tab-content">
            <div id="injuryPrevention"></div>
            <div class="alert-box-info">
                <strong class="alert-title-primary">‚úì Low Risk Status</strong>
                <p class="alert-text">No injury alerts detected. Your alignment, mobility, and balance scores indicate low injury risk for marathon training at current volume.</p>
            </div>

            <h3 class="section-heading-primary">Key Monitoring Areas</h3>
            <div class="monitoring-grid">
                <div class="monitoring-card monitoring-warning">
                    <strong>Volume Increases</strong><br>
                    <span class="monitoring-text">Week-to-week volume capped at 10% increase to minimize overtraining risk</span>
                </div>
                <div class="monitoring-card monitoring-success">
                    <strong>Mobility Maintenance</strong><br>
                    <span class="monitoring-text">Daily 10-minute mobility routine prevents tightness in hip flexors and calves</span>
                </div>
                <div class="monitoring-card monitoring-info">
                    <strong>Strength Consistency</strong><br>
                    <span class="monitoring-text">2x weekly strength sessions maintain single-leg stability and core power</span>
                </div>
            </div>
        </div>
    </div>

    <!-- WORKOUT DETAIL MODAL -->
    <div id="workoutModal" class="modal-custom" onclick="closeWorkoutModal(event)">
        <div class="modal-content-custom" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeWorkoutModal()">&times;</span>
            <div class="workout-detail-title" id="modalWorkoutTitle">Workout Title</div>

            <div class="workout-detail-item">
                <span class="workout-detail-label">Type</span>
                <span class="workout-detail-value" id="modalWorkoutType">Type</span>
            </div>

            <div class="workout-detail-item">
                <span class="workout-detail-label">Duration</span>
                <span class="workout-detail-value" id="modalWorkoutDuration">Duration</span>
            </div>

            <div class="workout-detail-item">
                <span class="workout-detail-label">Intensity Zone</span>
                <span class="workout-detail-value" id="modalWorkoutZone">Zone</span>
            </div>

            <div class="workout-detail-item">
                <span class="workout-detail-label">Description</span>
                <span class="workout-detail-value" id="modalWorkoutDesc">Description</span>
            </div>

            <div class="modal-divider">
                <button onclick="completeWorkout()" class="btn-success-full">Mark as Complete</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/api-client.js"></script>
    <script>
        // Simple loader and offline banner helpers
        function setTimeline(startIso, durationDays = 90) {
            const start = startIso ? new Date(startIso) : new Date();
            const end = new Date(start.getTime() + durationDays * 24 * 60 * 60 * 1000);
            const now = new Date();
            const remaining = Math.max(0, Math.ceil((end - now) / (24 * 60 * 60 * 1000)));
            const opts = { year: 'numeric', month: 'short', day: 'numeric' };
            document.getElementById('timelineDates').innerHTML = `${start.toLocaleDateString(undefined, opts)} ‚Üí ${end.toLocaleDateString(undefined, opts)}<br><strong>${remaining} days remaining</strong>`;
        }

        function setProgress(dayIndex = 0, totalDays = 90) {
            const pct = Math.min(100, Math.max(0, Math.round((dayIndex / totalDays) * 100)));
            const week = Math.min(12, Math.max(1, Math.ceil((dayIndex + 1) / 7)));
            document.getElementById('progressPercent').textContent = `${pct}%`;
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressWeek').textContent = `Week ${week} / 12`;
        }

        async function initProtocol() {
            try {
                const params = new URLSearchParams(window.location.search);
                const protocolId = params.get('protocolId');

                let protocol = null;
                if (protocolId) {
                    try {
                        protocol = await akuraAPI.getTrainingProtocol(protocolId);
                        localStorage.setItem(`protocol_${protocolId}`, JSON.stringify(protocol));
                    } catch (err) {
                        const cached = localStorage.getItem(`protocol_${protocolId}`);
                        if (cached) protocol = JSON.parse(cached);
                    }
                }

                // Populate header with protocol or sensible defaults
                const aifriScore = protocol?.aifriScore ?? (localStorage.getItem('aifriScore') ? Number(localStorage.getItem('aifriScore')) : null);
                const gradeLabel = aifriScore >= 80 ? 'ELITE' : aifriScore >= 70 ? 'ADVANCED' : aifriScore >= 60 ? 'COMPETENT' : 'FOUNDATION';
                document.getElementById('aifriScore').textContent = aifriScore != null ? aifriScore : '‚Äî';
                document.getElementById('aifriBadge').textContent = gradeLabel;

                document.getElementById('athleteName').textContent = protocol?.athlete?.name || 'Athlete';
                document.getElementById('athleteId').textContent = protocol?.athlete?.id ? `ID: ${protocol.athlete.id}` : 'ID: ‚Äî';
                document.getElementById('bodyType').textContent = protocol?.athlete?.bodyType || '‚Äî';
                document.getElementById('goalValue').textContent = protocol?.goal?.target || '‚Äî';
                document.getElementById('goalSubtext').textContent = protocol?.goal?.subtitle || '‚Äî';
                document.getElementById('protocolTitle').textContent = protocol?.title || '90-Day Endurance Builder';

                setTimeline(protocol?.startDate || new Date().toISOString(), protocol?.durationDays || 90);

                // Progress estimation: compute day index from start
                if (protocol?.startDate) {
                    const dayIdx = Math.floor((Date.now() - new Date(protocol.startDate).getTime()) / (24 * 60 * 60 * 1000));
                    setProgress(dayIdx, protocol?.durationDays || 90);
                } else {
                    setProgress(0, 90);
                }

                // Optionally, render weekly list if protocol provides weeks
                if (protocol?.weeks && Array.isArray(protocol.weeks) && protocol.weeks.length) {
                    // Replace Weekly tab content with generated accordions
                    const weeklyTab = document.getElementById('weekly');
                    weeklyTab.innerHTML = '';
                    protocol.weeks.forEach(week => {
                        const km = week.mileage ? `${week.mileage}km` : '';
                        const focus = week.focus || week.phase || 'Training';
                        const intensity = week.intensity || 'Moderate';
                        const status = week.status || '';
                        const acc = document.createElement('div');
                        acc.className = 'accordion-item-custom';
                        acc.innerHTML = `
                            <button class="accordion-toggle" onclick="toggleAccordion(event)">
                                <span>Week ${week.week || ''} - ${focus} <span class="week-label-muted">${km}</span></span>
                                <span class="accordion-toggle-icon">‚ñº</span>
                            </button>
                            <div class="accordion-content">
                              <div class="week-stats">
                                <div class="week-stat"><div class="week-stat-label">Total Volume</div><div class="week-stat-value">${km || '‚Äî'}</div></div>
                                <div class="week-stat"><div class="week-stat-label">Focus</div><div class="week-stat-value">${focus}</div></div>
                                <div class="week-stat"><div class="week-stat-label">Intensity</div><div class="week-stat-value">${intensity}</div></div>
                                <div class="week-stat"><div class="week-stat-label">Status</div><div class="week-stat-value status-success">${status || ''}</div></div>
                              </div>
                            </div>`;
                        weeklyTab.appendChild(acc);
                    });
                }
            } catch (e) {
                console.warn('Protocol init warning:', e);
            }
        }

        window.addEventListener('load', initProtocol);
        // Tab switching
        function switchTab(event, tabName) {
            event.preventDefault();
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active state from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            // Initialize chart if progress tab
            if (tabName === 'progress') {
                setTimeout(initProgressChart, 100);
            }
        }

        // Accordion toggle
        function toggleAccordion(event) {
            const toggle = event.currentTarget;
            const content = toggle.nextElementSibling;

            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Workout modal
        function openWorkoutModal(title, description) {
            const modal = document.getElementById('workoutModal');
            document.getElementById('modalWorkoutTitle').textContent = title;
            document.getElementById('modalWorkoutDesc').textContent = description;

            // Parse type
            let type = 'Running';
            let zone = 'Z2';
            if (title.includes('Strength')) type = 'Strength';
            if (title.includes('Threshold')) zone = 'Z4';
            if (title.includes('Long')) zone = 'Z2';
            if (title.includes('Easy')) zone = 'Z2';

            document.getElementById('modalWorkoutType').textContent = type;
            document.getElementById('modalWorkoutZone').textContent = zone;
            document.getElementById('modalWorkoutDuration').textContent = description.includes('min') ? 
                description.split('(')[1].split(')')[0] : 'See description';

            modal.classList.add('active');
        }

        function closeWorkoutModal(event) {
            if (event && event.target.id !== 'workoutModal') return;
            document.getElementById('workoutModal').classList.remove('active');
        }

        function completeWorkout() {
            alert('Workout marked as complete! üéâ');
            closeWorkoutModal();
        }

        // Progress chart
        function initProgressChart() {
            const ctx = document.getElementById('progressChart');
            if (window.progressChart) {
                window.progressChart.destroy();
            }

            window.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start', 'Week 3', 'Week 6', 'Week 9', 'Week 12'],
                    datasets: [
                        {
                            label: 'Running',
                            data: [75, 76, 78, 82, 85],
                            borderColor: '#1e3a5f',
                            backgroundColor: 'rgba(30, 58, 95, 0.1)',
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#1e3a5f'
                        },
                        {
                            label: 'Strength',
                            data: [80, 80, 82, 85, 88],
                            borderColor: '#FF9500',
                            backgroundColor: 'rgba(255, 149, 0, 0.1)',
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#FF9500'
                        },
                        {
                            label: 'ROM',
                            data: [70, 71, 73, 76, 78],
                            borderColor: '#33BEF3',
                            backgroundColor: 'rgba(51, 190, 243, 0.1)',
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#33BEF3'
                        },
                        {
                            label: 'Balance',
                            data: [85, 85, 87, 89, 90],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#4CAF50'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12, weight: 600 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 60,
                            max: 100,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    </script>
        <script>
// ============================================
// TRAINING PLANS - PROTOCOL LOADER (wrappers)
// ============================================
function showLoadingSpinner(message = 'Loading...') { console.log(`‚è≥ ${message}`); }
function hideLoadingSpinner() {}
function showErrorMessage(message) { alert(message); }
async function getTrainingProtocol(protocolId) { return akuraAPI.getTrainingProtocol(protocolId); }
function generateMockProtocol(protocolId) {
    return {
        protocolId,
        duration: 90,
        aifriScore: parseInt(localStorage.getItem('aifriScore')||'70'),
        injuryRisk: 'Moderate',
        weeks: [
            { week: 1, phase: 'Foundation', focus: 'Base Building', mileage: 32, workouts: 5, restDays: 2 },
            { week: 2, phase: 'Foundation', focus: 'Aerobic Endurance', mileage: 34, workouts: 5, restDays: 2 }
        ],
        daily: [
            { day: 1, type: 'Easy Run', description: 'Easy 30min + mobility', duration: 30, intensity: 'Low' },
            { day: 2, type: 'Strength', description: 'Core & lower body', duration: 45, intensity: 'Low-Moderate' },
            { day: 3, type: 'Tempo Run', description: '20min @ steady', duration: 40, intensity: 'Moderate' },
            { day: 4, type: 'Easy Run', description: 'Recovery jog', duration: 30, intensity: 'Low' },
            { day: 5, type: 'Intervals', description: '6x400m Z4', duration: 50, intensity: 'Moderate-High' },
            { day: 6, type: 'Long Run', description: 'Long aerobic run', duration: 75, intensity: 'Low' },
            { day: 7, type: 'Rest', description: 'Rest + mobility', duration: 0, intensity: 'Rest' }
        ]
    };
}

// ============================================
// TRAINING PLANS - PROTOCOL LOADER
// ============================================
window.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÑ Loading training plans page...');
    const urlParams = new URLSearchParams(window.location.search);
    const protocolId = (urlParams.get('protocolId') || localStorage.getItem('protocolId') || '').trim();
    const cachedAssessment = JSON.parse(localStorage.getItem('assessment') || '{}');
    const cachedAifri = parseInt(localStorage.getItem('aifriScore') || '', 10);

    if (!protocolId) {
        if (Object.keys(cachedAssessment).length > 0 || !Number.isNaN(cachedAifri)) {
            console.warn('‚ö†Ô∏è No protocol ID found; using cached data to render mock protocol.');
            const mockProtocol = generateMockProtocol(`mock_${Date.now()}`);
            localStorage.setItem('protocolId', mockProtocol.protocolId);
            renderProtocolOverview(mockProtocol);
            renderWeeklyPlan(mockProtocol.weeks);
            renderDailyWorkouts(mockProtocol.daily);
            renderProgressChart(mockProtocol);
            renderInjuryPrevention(mockProtocol.injuryRisk);
            return;
        }

        console.error('‚ùå No protocol ID found - redirecting to assessment');
        showErrorMessage('No training plan found. Please complete the assessment first.');
        setTimeout(() => { window.location.href = 'assessment-intake.html'; }, 3000);
        return;
    }

    console.log(`üì• Loading protocol: ${protocolId}`);
    showLoadingSpinner('Loading your personalized 90-day protocol...');

    try {
        const protocol = await getTrainingProtocol(protocolId);
        console.log('‚úÖ Protocol loaded:', protocol);
        hideLoadingSpinner();

        renderProtocolOverview(protocol);
        renderWeeklyPlan(protocol.weeks);
        renderDailyWorkouts(protocol.daily);
        renderProgressChart(protocol);
        renderInjuryPrevention(protocol.injuryRisk);
    } catch (error) {
        console.error('‚ùå Failed to load protocol:', error);
        hideLoadingSpinner();
        showErrorMessage(`Unable to load training plan: ${error.message}\n\nShowing cached data if available.`);

        const cachedAifriScore = Number.isNaN(cachedAifri) ? 70 : cachedAifri;
        const effectiveProtocolId = protocolId || `mock_${Date.now()}`;

        // Always show a mock protocol so the page renders even if backend is down and no assessment is cached.
        const mockProtocol = generateMockProtocol(effectiveProtocolId);
        mockProtocol.aifriScore = cachedAifriScore;
        if (!mockProtocol.injuryRisk) mockProtocol.injuryRisk = 'Moderate';

        console.warn('‚ö†Ô∏è Falling back to mock protocol (offline/backup path).');
        renderProtocolOverview(mockProtocol);
        renderWeeklyPlan(mockProtocol.weeks);
        renderDailyWorkouts(mockProtocol.daily);
        renderProgressChart(mockProtocol);
        renderInjuryPrevention(mockProtocol.injuryRisk);
    }
});

// ============================================
// RENDERING FUNCTIONS
// ============================================
function renderProtocolOverview(protocol) {
    const overviewContainer = document.getElementById('protocolOverview');
    if (!overviewContainer) return;
    const aifriScore = protocol.aifriScore || parseInt(localStorage.getItem('aifriScore') || '70');
    const injuryRisk = protocol.injuryRisk || 'Moderate';
    overviewContainer.innerHTML = `
        <div class="protocol-summary card">
            <div class="card-body">
                <h3>Your 90-Day Adaptive Protocol</h3>
                <div class="stats-grid">
                    <div class="stat"><span class="label">AIFRI Score</span><span class="value ${getScoreClass(aifriScore)}">${aifriScore}</span></div>
                    <div class="stat"><span class="label">Injury Risk</span><span class="value ${getRiskClass(injuryRisk)}">${injuryRisk}</span></div>
                    <div class="stat"><span class="label">Duration</span><span class="value">${protocol.duration || 90} days</span></div>
                    <div class="stat"><span class="label">Weekly Workouts</span><span class="value">5-6 days</span></div>
                </div>
            </div>
        </div>`;
}
function renderWeeklyPlan(weeks) {
    const weeklyContainer = document.getElementById('weeklyPlan');
    if (!weeklyContainer || !weeks) return;
    weeklyContainer.innerHTML = weeks.map(week => `
        <div class="week-card card">
            <div class="card-header"><h4>Week ${week.week} - ${week.phase}</h4></div>
            <div class="card-body">
                <p><strong>Focus:</strong> ${week.focus}</p>
                <p><strong>Weekly Mileage:</strong> ${week.mileage} km</p>
                <p><strong>Workouts:</strong> ${week.workouts} days | Rest: ${week.restDays} days</p>
            </div>
        </div>`).join('');
}
function renderDailyWorkouts(daily) {
    const dailyContainer = document.getElementById('dailyWorkouts');
    if (!dailyContainer || !daily) return;
    const firstWeek = daily.slice(0, 7);
    dailyContainer.innerHTML = firstWeek.map(workout => `
        <div class="workout-card card">
            <div class="card-body">
                <h5>Day ${workout.day} - ${workout.type}</h5>
                <p>${workout.description}</p>
                <div class="workout-meta">
                    <span><strong>Duration:</strong> ${workout.duration} min</span>
                    <span><strong>Intensity:</strong> ${workout.intensity}</span>
                </div>
            </div>
        </div>`).join('');
}
function renderProgressChart(protocol) {
    const chartContainer = document.getElementById('progressChart');
    if (!chartContainer) return;
    console.log('üìä Rendering progress chart...');
}
function renderInjuryPrevention(injuryRisk) {
    const injuryContainer = document.getElementById('injuryPrevention');
    if (!injuryContainer) return;
    injuryContainer.innerHTML = `
        <div class="alert ${getRiskAlertClass(injuryRisk)}">
            <h4>Injury Risk: ${injuryRisk}</h4>
            <p>${getInjuryRiskMessage(injuryRisk)}</p>
        </div>`;
}
function getScoreClass(score) { if (score >= 80) return 'text-success'; if (score >= 60) return 'text-warning'; return 'text-danger'; }
function getRiskClass(risk) { if (risk === 'Low') return 'text-success'; if (risk === 'Moderate') return 'text-warning'; return 'text-danger'; }
function getRiskAlertClass(risk) { if (risk === 'Low') return 'alert-success'; if (risk === 'Moderate') return 'alert-warning'; return 'alert-danger'; }
function getInjuryRiskMessage(risk) {
    if (risk === 'Low') { return 'Excellent! Your movement patterns and conditioning support safe training progression.'; }
    else if (risk === 'Moderate') { return 'Focus on the corrective exercises in your plan to reduce injury risk before increasing mileage.'; }
    else { return 'High priority: Address alignment and mobility issues. Consult with your coach or PT before progressing.'; }
}
        </script>
</body>
</html>
